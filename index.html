<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --text-primary: #111827;
      --text-secondary: #4B5563;
      --border: #E5E7EB;
      --background: #C8C8C8;

      --danger: #D92D20;
      --success: #079455;

      --radius-card: 24px;
      --radius-control: 8px;

      --shadow-card: 0px 4px 6px -2px #10182808, 0px 12px 16px -4px #10182814;
      --focus: 0 0 0 4px rgba(22, 70, 206, 0.18);

      /* 4px scale */
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-28: 28px;
      --space-32: 32px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter Display", Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      margin: 0;
      color: var(--text-primary);
      background: var(--background);
    }

    /* Webflow-style layout primitives (kept small on purpose) */
    .page-wrapper { min-height: 100%; padding: 1rem; }
    .container { max-width: 1040px; margin: 0 auto; }
    .section { padding: 0; }

    .grid-2col {
      display: grid;
      /* One column on all devices (consistent behavior) */
      grid-template-columns: 1fr;
      gap: var(--space-20);
      align-items: start;
    }

    @media (max-width: 991px) {
      .grid-2col { grid-template-columns: 1fr; }
    }

    .card, .card-2 {
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      padding: var(--space-24);
      box-shadow: var(--shadow-card);
      background: #fff;
      max-width: 40rem;
      width: 100%;
      margin: 0 auto;
    }

    .stack { display: flex; flex-direction: column; gap: var(--space-16); }
    .stack-lg { gap: var(--space-24); }
    .row { display: flex; gap: var(--space-12); align-items: center; flex-wrap: wrap; }
    .row-between { justify-content: space-between; }
    .calculator-panel { display: flex; flex-direction: column; }
    .collapsible {
      margin-top: var(--space-16);
      overflow: hidden;
      max-height: none;
      opacity: 1;
      transform: translateY(0);
      transition: max-height 260ms ease, opacity 200ms ease, transform 200ms ease, margin-top 200ms ease;
      will-change: max-height, opacity, transform;
    }
    .collapsible.is-collapsed {
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      margin-top: 0;
    }
    .text-button {
      border: 0;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 999px;
      transition: color 160ms ease, background 160ms ease, box-shadow 160ms ease;
    }
    .text-button:hover {
      color: var(--text-primary);
      background: rgba(17, 24, 39, 0.06);
    }
    .text-button:focus-visible {
      outline: none;
      box-shadow: var(--focus);
    }

    .heading-xl { font-size: 28px; line-height: 1.2; margin: 0; letter-spacing: -0.02em; }
    .heading-md { font-size: 18px; line-height: 1.3; margin: 0; letter-spacing: -0.01em; }
    .text-muted { color: var(--text-secondary); margin: 0; }
    .text-sm { font-size: 13px; line-height: 1.5; }

    .form-field { display: grid; gap: var(--space-8); }
    .label { font-size: 13px; font-weight: 500; color: var(--text-primary); }

    .input, .select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      height: 56px;
      padding: 0 var(--space-16);
      font-size: 16px;
      outline: none;
      background: #fff;
      color: var(--text-primary);
      transition: box-shadow 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .input:focus, .select:focus { box-shadow: var(--focus); border-color: rgba(22, 70, 206, 0.35); }

    .help, .error {
      font-size: 13px;
      margin: 0;
    }

    .help { color: var(--text-secondary); }
    .error { color: var(--danger); display: none; }
    .field-invalid .input, .field-invalid .select { border-color: rgba(217, 45, 32, 0.45); }
    .field-invalid .error { display: block; }

    .segmented {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
      background: rgba(17, 24, 39, 0.03);
      gap: 4px;
    }

    .segmented-button {
      border: 0;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 160ms ease, color 160ms ease, transform 160ms ease;
    }

    .segmented-button[aria-pressed="true"] {
      background: #fff;
      color: var(--text-primary);
      box-shadow: 0 8px 18px rgba(17, 24, 39, 0.08);
    }

    .button {
      width: 100%;
      height: 56px;
      border: 0;
      background: linear-gradient(to bottom, #3D65D6 0%, #1646CE 100%);
      color: #fff;
      font-size: 16px;
      font-weight: 500;
      border-radius: var(--radius-control);
      padding: 0 var(--space-16);
      cursor: pointer;
      transition: transform 120ms ease, opacity 120ms ease;
      box-shadow: none;
    }

    .button:active { transform: translateY(0px); }
    .button:disabled { cursor: not-allowed; transform: none; }

    /* Results: hidden until valid input + smooth reveal */
    .results {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(8px);
      transition: max-height 360ms ease, opacity 240ms ease, transform 240ms ease;
      will-change: max-height, opacity, transform;
      pointer-events: none;
    }

    .results.is-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-12);
      margin-top: var(--space-12);
    }

    .metric {
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      padding: var(--space-16);
      background: rgba(17, 24, 39, 0.02);
    }

    .metric-spaced { margin-top: var(--space-12); }

    .metric .k { font-size: 13px; color: var(--text-secondary); margin: 0 0 6px; }
    .metric .v { font-size: 20px; font-weight: 600; margin: 0; letter-spacing: -0.01em; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-8);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17, 24, 39, 0.02);
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
      display: inline-block;
    }

  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="container section">
      <div class="stack stack-lg">
        <div class="grid-2col">
          <!-- Calculator -->
          <div class="card">
            <div class="calculator-panel">
              <div class="row row-between">
                <h2 class="heading-md">Your details</h2>
                <div class="row">
                  <p class="text-muted text-sm">Estimates only.</p>
                  <button class="text-button" id="toggleCalculator" type="button" aria-expanded="true" aria-controls="calculatorBody">Hide details</button>
                </div>
              </div>

              <div class="collapsible" id="calculatorBody">
                <div class="stack">
                  <div class="form-field" id="tokenGrantField">
                    <label class="label" for="tokenGrant">Token grant (total tokens)</label>
                    <input class="input" id="tokenGrant" name="tokenGrant" inputmode="decimal" autocomplete="off" placeholder="e.g. 50000" />
                    <p class="error" id="tokenGrantError">Enter a valid token grant greater than 0.</p>
                  </div>

                  <div class="form-field" id="expectedPriceField">
                    <label class="label" for="expectedPrice">Expected token price (USD)</label>
                    <input class="input" id="expectedPrice" name="expectedPrice" inputmode="decimal" autocomplete="off" placeholder="e.g. 1.50" />
                    <p class="error" id="expectedPriceError">Enter a valid expected price greater than 0.</p>
                  </div>

                  <div class="form-field" id="currentPriceField">
                    <label class="label" for="currentPrice">Current token price (USD)</label>
                    <input class="input" id="currentPrice" name="currentPrice" inputmode="decimal" autocomplete="off" placeholder="e.g. 0.25" />
                    <p class="error" id="currentPriceError">Enter a valid current price (0 or greater).</p>
                  </div>

                  <div class="form-field" id="vestingYearsField">
                    <label class="label" for="vestingYears">Vesting schedule (years)</label>
                    <input class="input" id="vestingYears" name="vestingYears" inputmode="decimal" autocomplete="off" placeholder="e.g. 4" />
                    <p class="help">Assumes straight-line monthly vesting.</p>
                    <p class="error" id="vestingYearsError">Enter a valid vesting length greater than 0.</p>
                  </div>

                  <div class="form-field" id="taxRateField">
                    <label class="label" for="taxRate">Estimated tax rate (%)</label>
                    <input class="input" id="taxRate" name="taxRate" inputmode="decimal" autocomplete="off" placeholder="e.g. 30" />
                    <p class="error" id="taxRateError">Enter a tax rate between 0 and 100.</p>
                  </div>

                  <button class="button" id="calculate" type="button">Calculate</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Results (always visible card, inner panel expands on Calculate) -->
          <div class="card-2" aria-live="polite">
            <div class="row row-between">
              <h2 class="heading-md">Results</h2>
            </div>

            <div class="results" id="results" aria-hidden="true" style="max-height:0px;">
              <div class="results-grid">
                <div class="metric">
                  <p class="k">Expected valuation</p>
                  <p class="v" id="expectedValuation">—</p>
                </div>
                <div class="metric">
                  <p class="k">Monthly vesting value</p>
                  <p class="v" id="monthlyVestingValue">—</p>
                </div>
                <div class="metric">
                  <p class="k">Tax liabilities</p>
                  <p class="v" id="taxLiability">—</p>
                </div>
                <div class="metric">
                  <p class="k">What your tokens are worth today</p>
                  <p class="v" id="currentValue">—</p>
                </div>
              </div>
            </div>

            <div class="text-muted text-sm" id="resultsHint">Fill in the form to see your results.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      tokenGrant: document.getElementById("tokenGrant"),
      expectedPrice: document.getElementById("expectedPrice"),
      currentPrice: document.getElementById("currentPrice"),
      vestingYears: document.getElementById("vestingYears"),
      taxRate: document.getElementById("taxRate"),
      calculate: document.getElementById("calculate"),
      toggleCalculator: document.getElementById("toggleCalculator"),
      calculatorBody: document.getElementById("calculatorBody"),

      tokenGrantField: document.getElementById("tokenGrantField"),
      expectedPriceField: document.getElementById("expectedPriceField"),
      currentPriceField: document.getElementById("currentPriceField"),
      vestingYearsField: document.getElementById("vestingYearsField"),
      taxRateField: document.getElementById("taxRateField"),

      results: document.getElementById("results"),
      resultsHint: document.getElementById("resultsHint"),
      expectedValuation: document.getElementById("expectedValuation"),
      monthlyVestingValue: document.getElementById("monthlyVestingValue"),
      taxLiability: document.getElementById("taxLiability"),
      currentValue: document.getElementById("currentValue"),
    };

    const CURRENCY = "USD";
    let hasCalculated = false;
    let calculatorCollapsed = false;

    let heightPostRaf = 0;
    function notifyParentHeight() {
      // When embedded in an iframe, the parent page won't auto-resize.
      // Post a robust height measurement to the parent so it can resize the iframe.
      try {
        if (!window.parent || window.parent === window) return;
        if (heightPostRaf) cancelAnimationFrame(heightPostRaf);
        heightPostRaf = requestAnimationFrame(() => {
          const body = document.body;
          const html = document.documentElement;
          // NOTE:
          // - scrollHeight can stay large even when content is clipped by max-height + overflow:hidden.
          // - offsetHeight / bounding rect reflect the laid-out height we want the iframe to match.
          const bodyRectH = body?.getBoundingClientRect?.().height ?? 0;
          const htmlRectH = html?.getBoundingClientRect?.().height ?? 0;
          const height = Math.ceil(Math.max(
            body?.offsetHeight ?? 0,
            html?.offsetHeight ?? 0,
            bodyRectH,
            htmlRectH,
          ));
          window.parent.postMessage({ type: "token-calculator:height", height }, "*");
          heightPostRaf = 0;
        });
      } catch {
        // ignore
      }
    }

    function formatMoney(value) {
      try {
        return new Intl.NumberFormat(undefined, {
          style: "currency",
          currency: CURRENCY,
          maximumFractionDigits: 0,
        }).format(value);
      } catch {
        return `${CURRENCY} ${Math.round(value).toLocaleString()}`;
      }
    }

    function setCalculatorCollapsed(collapsed, { animate = true } = {}) {
      if (!els.calculatorBody || !els.toggleCalculator) return;
      calculatorCollapsed = Boolean(collapsed);
      els.toggleCalculator.setAttribute("aria-expanded", String(!calculatorCollapsed));
      els.toggleCalculator.textContent = calculatorCollapsed ? "Show details" : "Hide details";

      if (calculatorCollapsed) {
        const currentHeight = els.calculatorBody.style.maxHeight === "none"
          ? els.calculatorBody.scrollHeight
          : els.calculatorBody.scrollHeight;
        els.calculatorBody.style.maxHeight = `${currentHeight}px`;
        if (!animate) {
          els.calculatorBody.classList.add("is-collapsed");
          els.calculatorBody.style.maxHeight = "0px";
          notifyParentHeight();
          return;
        }
        void els.calculatorBody.offsetHeight;
        els.calculatorBody.classList.add("is-collapsed");
        els.calculatorBody.style.maxHeight = "0px";
      } else {
        els.calculatorBody.classList.remove("is-collapsed");
        if (!animate) {
          els.calculatorBody.style.maxHeight = "none";
          notifyParentHeight();
          return;
        }
        els.calculatorBody.style.maxHeight = "0px";
        requestAnimationFrame(() => {
          els.calculatorBody.style.maxHeight = `${els.calculatorBody.scrollHeight}px`;
          notifyParentHeight();
        });
      }

      notifyParentHeight();
    }

    function parseNumber(raw) {
      const cleaned = String(raw ?? "").trim().replace(/[, ]+/g, "");
      if (!cleaned) return NaN;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : NaN;
    }

    function isClearedToDefault() {
      const fields = [
        els.tokenGrant,
        els.expectedPrice,
        els.currentPrice,
        els.vestingYears,
        els.taxRate,
      ];
      const inputsEmpty = fields.every((field) => !String(field.value || "").trim());
      return inputsEmpty;
    }

    function showResults() {
      els.results.setAttribute("aria-hidden", "false");
      els.resultsHint.style.display = "none";
      els.results.classList.add("is-visible");
      // Expand (no scrolling): animate to actual content height.
      requestAnimationFrame(() => {
        els.results.style.maxHeight = `${els.results.scrollHeight}px`;
        notifyParentHeight();
      });
    }

    function hideResults() {
      hasCalculated = false;
      // Animate collapse (no scrolling): set current height -> 0.
      const currentHeight = els.results.style.maxHeight === "none"
        ? els.results.scrollHeight
        : els.results.scrollHeight;
      els.results.style.maxHeight = `${currentHeight}px`;
      void els.results.offsetHeight;
      els.results.classList.remove("is-visible");
      els.results.style.maxHeight = "0px";
      els.results.setAttribute("aria-hidden", "true");
      els.resultsHint.style.display = "";
      notifyParentHeight();
    }

    function setFieldValidity(fieldEl, isValid, { showErrors }) {
      fieldEl.classList.toggle("field-invalid", Boolean(showErrors && !isValid));
    }

    function validate({ showErrors }) {
      const tokenGrant = parseNumber(els.tokenGrant.value);
      const expectedPrice = parseNumber(els.expectedPrice.value);
      const currentPrice = parseNumber(els.currentPrice.value);
      const vestingYears = parseNumber(els.vestingYears.value);
      const taxRate = parseNumber(els.taxRate.value);

      const tokenGrantValid = Number.isFinite(tokenGrant) && tokenGrant > 0;
      const expectedPriceValid = Number.isFinite(expectedPrice) && expectedPrice > 0;
      const currentPriceValid = Number.isFinite(currentPrice) && currentPrice >= 0;
      const vestingYearsValid = Number.isFinite(vestingYears) && vestingYears > 0;
      const taxRateValid = Number.isFinite(taxRate) && taxRate >= 0 && taxRate <= 100;

      setFieldValidity(els.tokenGrantField, tokenGrantValid, { showErrors });
      setFieldValidity(els.expectedPriceField, expectedPriceValid, { showErrors });
      setFieldValidity(els.currentPriceField, currentPriceValid, { showErrors });
      setFieldValidity(els.vestingYearsField, vestingYearsValid, { showErrors });
      setFieldValidity(els.taxRateField, taxRateValid, { showErrors });

      const allValid = tokenGrantValid
        && expectedPriceValid
        && currentPriceValid
        && vestingYearsValid
        && taxRateValid;

      return {
        allValid,
        tokenGrant,
        expectedPrice,
        currentPrice,
        vestingYears,
        taxRate,
      };
    }

    function calculate(v) {
      const totalVestingMonths = v.vestingYears * 12;
      const expectedValuation = v.tokenGrant * v.expectedPrice;
      const monthlyTokens = totalVestingMonths > 0
        ? v.tokenGrant / totalVestingMonths
        : 0;
      const monthlyVestingValue = monthlyTokens * v.expectedPrice;
      const taxLiability = expectedValuation * (v.taxRate / 100);
      const currentValue = v.tokenGrant * v.currentPrice;

      els.expectedValuation.textContent = formatMoney(expectedValuation);
      els.monthlyVestingValue.textContent = formatMoney(monthlyVestingValue);
      els.taxLiability.textContent = formatMoney(taxLiability);
      els.currentValue.textContent = formatMoney(currentValue);
    }

    function validateAndMaybeCalculate({ shouldCalculate }) {
      // Only reset results to the default state when ALL fields are reset.
      if (isClearedToDefault()) {
        hideResults();
        validate({ showErrors: shouldCalculate });
        return;
      }

      // Only show error messages on an explicit calculate attempt.
      const v = validate({ showErrors: shouldCalculate });
      if (!v.allValid) {
        // Keep the last calculated results visible even if inputs become invalid.
        // Only hide results if we haven't successfully calculated yet.
        if (!hasCalculated) hideResults();
        return;
      }

      if (shouldCalculate) {
        hasCalculated = true;
        calculate(v);
        showResults();
      }
    }

    // Wire up
    if (els.toggleCalculator && els.calculatorBody) {
      const params = new URLSearchParams(window.location.search);
      const startCollapsed = ["1", "true", "yes"].includes(
        (params.get("collapsed") || "").toLowerCase()
      );
      setCalculatorCollapsed(startCollapsed, { animate: false });

      els.toggleCalculator.addEventListener("click", () => {
        setCalculatorCollapsed(!calculatorCollapsed);
      });

      els.calculatorBody.addEventListener("transitionend", (e) => {
        if (e.propertyName !== "max-height") return;
        if (!els.calculatorBody.classList.contains("is-collapsed")) {
          els.calculatorBody.style.maxHeight = "none";
        }
        notifyParentHeight();
      });
    } else {
      notifyParentHeight();
    }

    // Continuously report height changes (fonts load, results expand, responsive wraps, etc.)
    try {
      const ro = new ResizeObserver(() => notifyParentHeight());
      ro.observe(document.documentElement);
      ro.observe(document.body);
    } catch {
      // ResizeObserver not supported; fall back to the explicit calls elsewhere.
    }

    const inputs = [
      els.tokenGrant,
      els.expectedPrice,
      els.currentPrice,
      els.vestingYears,
      els.taxRate,
    ];

    const liveUpdate = () => {
      if (!hasCalculated) return;
      if (isClearedToDefault()) {
        hideResults();
        validate({ showErrors: false });
        return;
      }
      const v = validate({ showErrors: false });
      if (v.allValid) {
        calculate(v);
        showResults();
      }
    };

    inputs.forEach((input) => {
      input.addEventListener("input", liveUpdate);
      input.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        validateAndMaybeCalculate({ shouldCalculate: true });
      });
    });

    els.calculate.addEventListener("click", () => {
      validateAndMaybeCalculate({ shouldCalculate: true });
    });

    // Keep expanded height correct on responsive reflow.
    window.addEventListener("resize", () => {
      if (
        els.calculatorBody
        && !els.calculatorBody.classList.contains("is-collapsed")
        && els.calculatorBody.style.maxHeight !== "none"
      ) {
        els.calculatorBody.style.maxHeight = `${els.calculatorBody.scrollHeight}px`;
      }
      if (els.results.classList.contains("is-visible")) {
        // If we set max-height to none after transition, re-measure on resize.
        els.results.style.maxHeight = `${els.results.scrollHeight}px`;
      }
      notifyParentHeight();
    });

    // After expand transition completes, unlock height so it can grow naturally.
    els.results.addEventListener("transitionend", (e) => {
      if (e.propertyName !== "max-height") return;
      if (els.results.classList.contains("is-visible")) {
        els.results.style.maxHeight = "none";
      }
      notifyParentHeight();
    });

  </script>

</body>
</html>
